using System;
using System.Linq;
using System.Numerics;
using System.Collections.Generic;
using ECommons;
using ECommons.ImGuiMethods;
using Splatoon;
using Splatoon.SplatoonScripting;

namespace SplatoonScriptsOfficial.Generic
{
    public class ViperPositionals : SplatoonScript
    {
        // 実行範囲: null = 常に動作（必要なら特定のエリアIDセットに変更してください）
        public override HashSet<uint>? ValidTerritories => null;

        public override Metadata? Metadata => new(1, "Viper Positionals");

        // 効果ID: ユーザー指定の値（提供済み）
        private static readonly uint[] BackEffectIds = { 4093u, 4094u }; // 鋭牙【背裂】, 鋭牙【背撃】
        private static readonly uint[] SideEffectIds = { 4095u, 4096u }; // 鋭牙【側裂】, 鋭牙【側撃】

        public override void OnSetup()
        {
            // Back: AdditionalRotation = PI (背面)
            Controller.RegisterElementFromCode("Viper_Back", GetConeString("Viper_Back", 4278255360, MathF.PI));
            // Right: +90deg
            Controller.RegisterElementFromCode("Viper_Right", GetConeString("Viper_Right", 4278255615, MathF.PI / 2f));
            // Left: -90deg
            Controller.RegisterElementFromCode("Viper_Left", GetConeString("Viper_Left", 4278255615, -MathF.PI / 2f));
        }

        public override void OnUpdate()
        {
            var target = Svc.Targets.Target;
            if (target == null)
            {
                // ターゲットがいない場合は全て非表示
                SetEnabled("Viper_Back", false);
                SetEnabled("Viper_Left", false);
                SetEnabled("Viper_Right", false);
                return;
            }

            var hasBack = TargetHasAnyEffect(target, BackEffectIds);
            var hasSide = TargetHasAnyEffect(target, SideEffectIds);

            // 背面エフェクトがあれば背面を表示
            SetEnabled("Viper_Back", hasBack);

            // 側面エフェクトがあれば左右を表示（仕様に合わせて片側のみにする変更も可能）
            SetEnabled("Viper_Left", hasSide);
            SetEnabled("Viper_Right", hasSide);
        }

        private void SetEnabled(string name, bool enabled)
        {
            var el = Controller.GetElementByName(name);
            if (el != null) el.Enabled = enabled;
        }

        private bool TargetHasAnyEffect(IGameObject obj, uint[] ids)
        {
            if (obj is not IBattleChara c) return false;
            try
            {
                // StatusList 中の StatusId をチェック（既存スクリプトと同じ手法）
                return c.StatusList.Where(s => ids.Contains(s.StatusId)).Any();
            }
            catch
            {
                return false;
            }
        }

        // 要素の JSON テンプレート (type: 4 = ref-actor cone / fan)
        public string GetConeString(string name, uint color, float addAngle)
        {
            return $$"""
            {
                "Name": "{{name}}",
                "Enabled": false,
                "type": 4,
                "refActorType": 2,
                "Filled": true,
                "fillIntensity": 0.16,
                "radius": 0.0,
                "includeHitbox": true,
                "color": {{color}},
                "thicc": 2,
                "coneAngleMin": -30,
                "coneAngleMax": 30,
                "includeRotation": true,
                "AdditionalRotation": {{addAngle}}
            }
            """;
        }
    }
}
